<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#f0f0f0">
    <title>Eventos by AJRA</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="images/AJRA.png">
    <meta name="description" content="EVENTOS by AJRA">
    <meta property="og:title" content="EVENTOS by AJRA">
    <meta property="og:description" content="Calendario de eventos de AJRA">
    <meta property="og:image" content="eventos/eventos.png">
    <meta property="og:url" content="https://ajra.es/eventos">
    <script src="https://beamanalytics.b-cdn.net/beam.min.js" data-token="d475f634-84bb-448f-9a73-b0576d734398"
        async></script>
    <link href="style.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <header>
        <a href="https://ajra.es">
            <img src="eventos/AJRA.webp" alt="AJRA" class="avatar">
        </a>
    </header>
    <div class="home">
        <img src="eventos/logo.png" alt="AJRA" style="border-radius: 50%; margin-bottom: 25px;">
        <h1>CALENDARIO DE EVENTOS</h1>
        <h2>Listado de eventos de interes para AJRA</h2>
        <a href="webcal://p34-caldav.icloud.com/published/2/ODQ1NDIyNjE0NDg0NTQyMo15fzwE2IX1ODKW8DpK0P_-XEMxx90qs4ypC6BUm5wUqJKuS_4xGKrgnJjrrX2SHs3yg1yhMUV-BvWqcG40jkk">
            <h2 class="suscribirse">SUSCRIBETE</h2>
        </a>
    </div>
    <div class="filter-buttons">
        <button onclick="filterEvents('todos')" class="botonesfiltro">TODOS</button>
        <button onclick="filterEvents('cineytv')" class="botonesfiltro">CINEYTV</button>
        <button onclick="filterEvents('curiosidades')" class="botonesfiltro">CURIOSIDADES</button>
        <button onclick="filterEvents('deportes')" class="botonesfiltro">DEPORTES</button>
        <button onclick="filterEvents('festividades')" class="botonesfiltro">FESTIVIDADES</button>
        <button onclick="filterEvents('tecnologia')" class="botonesfiltro">TECNOLOGIA</button>
        <button onclick="filterEvents('videojuegos')" class="botonesfiltro">VIDEOJUEGOS</button>
        <input type="text" id="searchInput" class="buscador" oninput="searchResources()" placeholder="Buscar eventos...">
    </div>
    
    <div id="events" class="row"></div>
    <footer>2023 &copy; Desarrollado con 🧠 & 💛 por <a href="https://ajra.es"
            style="text-decoration: none; color: black"> &lt;/AJRA&gt; </a></footer>
</body>
</html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
<script>
    const SPREADSHEET_ID = '1bjuRsUCQLT_MwgKQ9GR7gPHJyYq339v-JHM_ErPbGjI';
    const API_KEY = 'AIzaSyBVknxjJb5j7AFLBrltXfOptE1xWweeGJ0';
    const eventsContainer = document.getElementById('events');
    const placeholderimagen = 'eventos/eventos.png';
    
    const formatDate = date => moment.tz(date, "America/New_York").format('L');
    
    const createEventCard = ({ titulo, eventDate, descripcion, imagen }) => {
        const today = moment.tz("America/New_York").startOf('day');
        const eventMoment = moment.tz(eventDate, "America/New_York");
        const daysRemaining = eventMoment.diff(today, 'days');
        const diasfaltan = `FALTAN ${daysRemaining} DÍAS`;


    const card = document.createElement('div');
    card.className = 'card';

    const imageElement = document.createElement('img');
    imageElement.className = 'event-image';
    imageElement.src = imagen;
    imageElement.alt = titulo;
    card.appendChild(imageElement);

    const cardBody = document.createElement('div');
    cardBody.className = 'card-body';

    const eventTitle = document.createElement('h2');
    eventTitle.className = 'titulo';
    eventTitle.textContent = titulo;
    
    const eventDateElement = document.createElement('p');
    eventDateElement.className = 'fecha';
    eventDateElement.textContent = formatDate(eventDate);
    
    const eventDescription = document.createElement('p');
    eventDescription.className = 'descripcion';
    eventDescription.textContent = descripcion;

    const daysRemainingContainer = document.createElement('div');
    daysRemainingContainer.className = 'faltan-container';

    const daysRemainingElement = document.createElement('p');
    daysRemainingElement.className = 'faltan';
    daysRemainingElement.textContent = diasfaltan;
    daysRemainingContainer.appendChild(daysRemainingElement);

    const generateICalButton = document.createElement('p');
    generateICalButton.className = 'iCal';
    generateICalButton.textContent = '+';
    generateICalButton.addEventListener('click', () => generateICalFile(titulo, eventDate, descripcion));
    daysRemainingContainer.appendChild(generateICalButton);

    [eventTitle, eventDateElement, eventDescription, daysRemainingContainer].forEach(element => cardBody.appendChild(element));
    card.appendChild(cardBody);

    return card;
};
    

    const generateICalFile = (titulo, startDate, descripcion) => {
    const eventDate = moment.tz(startDate, "America/New_York");
    let isAllDayEvent = (eventDate.hours() === 0 && eventDate.minutes() === 0);

    let startDateFormatted,
        endDateFormatted;

    if (isAllDayEvent) {
        startDateFormatted = eventDate.format('YYYYMMDD');
        endDateFormatted = eventDate
            .clone()
            .add(1, 'day')
            .format('YYYYMMDD');
    } else {
        startDateFormatted = eventDate.format('YYYYMMDDTHHmmss');
        endDateFormatted = eventDate
            .clone()
            .add(1, 'hour')
            .format('YYYYMMDDTHHmmss');
    }

    const iCalContent = `BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
BEGIN:VTIMEZONE
TZID:America/New_York
BEGIN:STANDARD
DTSTART:19701101T020000
TZNAME:EST
END:STANDARD
BEGIN:DAYLIGHT
DTSTART:19700308T020000
TZNAME:EDT
END:DAYLIGHT
END:VTIMEZONE
BEGIN:VEVENT
SUMMARY:${titulo}
DTSTART;TZID=America/New_York:${startDateFormatted}
DTEND;TZID=America/New_York:${endDateFormatted}
DESCRIPTION:${descripcion}
END:VEVENT
END:VCALENDAR`;

    const blob = new Blob([iCalContent], {type: 'text/calendar'});
    const url = window
        .URL
        .createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${titulo}.ics`;
    document
        .body
        .appendChild(a);
    a.click();
    window
        .URL
        .revokeObjectURL(url);
};
const fetchGoogleSheetEvents = () => {
    const now = moment.tz("America/New_York").startOf('day').toDate();
    const sheetRange = 'Eventos!A2:F';
    const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetRange}?key=${API_KEY}`;
    
    fetch(sheetUrl)
        .then(response => response.json())
        .then(data => {
            const rows = data.values || [];
            const events = rows
                .map(row => {
                    const [titulo, dateString, descripcion, imageFilename, categoriaRaw] = row;
                    const categoria = categoriaRaw.toLowerCase();
                    const eventDate = new Date(dateString);
                    return !isNaN(eventDate) && eventDate >= now 
                        ? { titulo, eventDate, descripcion, imagen: imageFilename ? `eventos/${imageFilename}` : placeholderimagen, categoria }
                        : null;
                })
                .filter(Boolean)
                .sort((a, b) => a.eventDate - b.eventDate);
                
                allEvents = events; 
            displayEvents(events); 
        })
        .catch(error => console.error('Error:', error));
};

function displayEvents(events) {
    eventsContainer.innerHTML = '';
    events.forEach(event => {
        eventsContainer.appendChild(createEventCard(event));
    });
}

function filterEvents(categoria) {
    document.querySelectorAll('.botonesfiltro').forEach(button => {
        button.classList.add('inactive');
    });

    if (categoria === 'todos') {
        document.querySelectorAll('.botonesfiltro').forEach(button => {
            button.classList.remove('inactive');
        });
        displayEvents(allEvents);
    } else {
        document.querySelector(`.botonesfiltro[onclick="filterEvents('${categoria}')"]`).classList.remove('inactive');
        const filteredEvents = allEvents.filter(event => event.categoria.toLowerCase() === categoria);
        displayEvents(filteredEvents);
    }
}

function searchResources() {
    const searchString = document.getElementById('searchInput').value.toLowerCase();

    const filteredEvents = allEvents.filter(event => 
        event.titulo.toLowerCase().includes(searchString) ||
        event.descripcion.toLowerCase().includes(searchString)
    );

    displayEvents(filteredEvents);
}

fetchGoogleSheetEvents();
</script>